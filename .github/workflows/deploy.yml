# name: Java CI/CD

# on:
#   workflow_dispatch:
#     inputs:
#       environment:
#         description: "Select environment"
#         type: choice
#         required: true
#         options:
#           - dev
#           - staging
#           - prod
#         default: dev

#       deploy:
#         description: "Deploy after build?"
#         type: boolean
#         required: true
#         default: false

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Java
#         uses: actions/setup-java@v4
#         with:
#           distribution: temurin
#           java-version: '17'

#       - name: Build with Maven
#         run: mvn -B clean install --no-transfer-progress

#       - name: Run tests
#         run: mvn test

#       - name: Show selected options
#         run: |
#           echo "Environment chosen: ${{ github.event.inputs.environment }}"
#           echo "Deploy? ${{ github.event.inputs.deploy }}"

#       - name: Deploy (only if checkbox = true)
#         if: ${{ github.event.inputs.deploy == 'true' }}
#         run: |
#           echo "Deploying to environment: ${{ github.event.inputs.environment }}"
#           # your deploy commands here
#           # example:
#           # scp target/app.jar user@server:/deploy/path/




name: Build & Push Image to GHCR

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Repository name (org/repo)"
        required: true
      environment:
        description: "Environment (dev / staging / prod)"
        required: true

permissions:
  contents: read
  packages: write   # REQUIRED to push to GHCR

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Parse repository name (org/repo ‚Üí repo)
      - name: Parse repository name only
        id: parse-repository-name
        run: |
          REPO="${{ github.event.inputs.repository }}"
          echo "REPOSITORY_NAME=$(echo "$REPO" | awk -F'/' '{print $NF}')" >> $GITHUB_OUTPUT

      # 3Ô∏è‚É£ Get commit SHA
      - name: Get checked out commit SHA
        id: repo-sha
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ üîê LOGIN TO GITHUB CONTAINER REGISTRY
      # WHY: Docker must be authenticated BEFORE push
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5Ô∏è‚É£ Build & push Docker image
      - name: Build and push image to GitHub Container Registry
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/yourrepo/${{ steps.parse-repository-name.outputs.REPOSITORY_NAME }}:${{ github.event.inputs.environment }}-${{ steps.repo-sha.outputs.sha }}

      # 6Ô∏è‚É£ Update Helm / values file
      - name: Update image repository and tag in values file
        run: |
          FILE="values.yaml"
          REPO_NAME="${{ steps.parse-repository-name.outputs.REPOSITORY_NAME }}"
          TAG="${{ github.event.inputs.environment }}-${{ steps.repo-sha.outputs.sha }}"

          sed -i.bak -E 's|^([[:space:]]*registry:[[:space:]]*).*$|\1ghcr.io|' "$FILE"
          sed -i.bak -E "s|^([[:space:]]*repository:[[:space:]]*).*$|\1yourrepo/$REPO_NAME|" "$FILE"
          sed -i.bak -E "s|^([[:space:]]*tag:[[:space:]]*).*$|\1\"$TAG\"|" "$FILE"
          rm -f "${FILE}.bak"

